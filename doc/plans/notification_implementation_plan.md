# 📱 WellFin 通知機能実装計画書

> **⚠️ 重要な注意事項**  
> この計画書は通知機能の実装中に一時的に作成されたものです。  
> **通知機能の実装が完了した時点で、この計画書は削除されます。**

---

## 📋 計画書概要

| 項目 | 詳細 |
|------|------|
| **作成日** | 2025年7月6日 |
| **対象機能** | WellFin Android アプリ通知システム |
| **実装フェーズ** | Phase 5 通知システム設計・実装 |
| **計画期間** | 4-6週間（段階的実装） |
| **削除予定** | 通知機能実装完了時 |

---

## 🎯 通知機能の必要性分析

### 現在のWellFinアプリ機能と通知ニーズ

| 機能 | 概要 | 通知必要性 | 理由 |
|------|------|------------|------|
| 🗓️ **カレンダー** | Google Calendar連携 | **高** | 予定の見逃し防止、事前準備 |
| 📝 **タスク管理** | To-Doリスト・スケジューリング | **高** | 締切管理、実行リマインダー |
| 🔄 **習慣トラッキング** | 習慣の継続管理 | **高** | 継続のためのリマインダー |
| 🎯 **目標設定** | 長期目標の管理 | **中** | 進捗確認、モチベーション維持 |
| 📊 **分析機能** | 生産性分析・レポート | **中** | 結果の確認、改善のきっかけ |
| 🤖 **AI最適化** | AI提案・改善案 | **中** | 提案の活用、行動変容の促進 |

---

## 🔔 通知タイプの詳細分析

### 1. プッシュ通知（Push Notifications）
#### 技術仕様
- **実装**: Firebase Cloud Messaging (FCM)
- **到達範囲**: アプリ外でも受信可能
- **実装コスト**: 高（2-3週間）

#### メリット・デメリット
| メリット | デメリット |
|----------|------------|
| ✅ アプリ外でも受信 | ❌ 実装コスト高 |
| ✅ サーバーから送信 | ❌ 通知疲れリスク |
| ✅ 高い到達率 | ❌ 通知許可が必要 |
| ✅ 豊富な機能 | ❌ バックエンドサーバー必要 |

#### 適用場面
- 🔄 **習慣リマインダー**: 「朝の運動」の時間です（連続7日目！）
- 📅 **重要なイベント**: 10分後: プロジェクト会議
- 🤖 **AI週次レポート**: 週次分析が完了しました

### 2. ローカル通知（Local Notifications）
#### 技術仕様
- **実装**: Android AlarmManager + NotificationCompat
- **到達範囲**: 端末内でスケジュール実行
- **実装コスト**: 低（1週間）

#### メリット・デメリット
| メリット | デメリット |
|----------|------------|
| ✅ 実装が簡単 | ❌ 端末依存 |
| ✅ オフライン動作 | ❌ 柔軟性に欠ける |
| ✅ 正確なタイミング | ❌ 豊富な機能なし |
| ✅ 通知許可不要（一部） | ❌ サーバー連携なし |

#### 適用場面
- ⏰ **締切アラート**: 「月次レポート」締切24時間前
- 📅 **カレンダーイベント**: 30分前のリマインダー
- 🔄 **習慣の時間**: 毎日19:00の読書時間

### 3. アプリ内通知（In-App Notifications）
#### 技術仕様
- **実装**: Provider + SnackBar/Dialog
- **到達範囲**: アプリ内でのリアルタイム表示
- **実装コスト**: 低（1週間）

#### メリット・デメリット
| メリット | デメリット |
|----------|------------|
| ✅ 実装が簡単 | ❌ アプリ内限定 |
| ✅ 完全制御可能 | ❌ 見逃しやすい |
| ✅ 美しいUI/UX | ❌ 永続性なし |
| ✅ リアルタイム表示 | ❌ バックグラウンド動作なし |

#### 適用場面
- 🤖 **AI分析完了**: 生産性スコア82点（+5点向上）
- ✅ **タスク完了**: 「プロジェクト計画書」完了！
- 📊 **データ同期**: Google Calendar同期完了

### 4. バッジ通知（Badge Notifications）
#### 技術仕様
- **実装**: Android App Shortcuts + BadgeDrawable
- **到達範囲**: アプリアイコンでの視覚的表示
- **実装コスト**: 低（数日）

#### メリット・デメリット
| メリット | デメリット |
|----------|------------|
| ✅ 非侵入的 | ❌ 気づきにくい |
| ✅ 常時表示 | ❌ 詳細情報なし |
| ✅ 実装が簡単 | ❌ 限定的な機能 |

#### 適用場面
- 📝 **未完了タスク数**: アプリアイコンに「3」
- 🔄 **継続日数**: 習慣の継続記録
- 📊 **未読分析数**: 確認待ちの分析結果

---

## 🛠️ 技術実装の検討

### Firebase Cloud Messaging (FCM) 実装仕様

#### 必要なパッケージ
```yaml
dependencies:
  firebase_core: ^2.24.2
  firebase_messaging: ^14.7.10
  flutter_local_notifications: ^17.0.0
```

#### 実装ステップ
1. **Firebase プロジェクト設定**
   - Google Cloud Console でプロジェクト作成
   - Android アプリ追加
   - google-services.json 配置

2. **FCM 初期化**
   ```dart
   await Firebase.initializeApp();
   await FirebaseMessaging.instance.requestPermission();
   ```

3. **メッセージ受信処理**
   ```dart
   FirebaseMessaging.onMessage.listen((message) {
     // フォアグラウンド時の処理
   });
   ```

4. **バックエンドサーバー**
   - Node.js + Express
   - Firebase Admin SDK
   - 通知送信 API

### ローカル通知実装仕様

#### 必要なパッケージ
```yaml
dependencies:
  flutter_local_notifications: ^17.0.0
  timezone: ^0.9.2
```

#### 実装ステップ
1. **初期化**
   ```dart
   final notifications = FlutterLocalNotificationsPlugin();
   await notifications.initialize(initializationSettings);
   ```

2. **スケジュール通知**
   ```dart
   await notifications.zonedSchedule(
     id: 1,
     title: '習慣リマインダー',
     body: '朝の運動の時間です',
     scheduledDate: nextInstanceOfTime(7, 0),
     uiLocalNotificationDateInterpretation:
         UILocalNotificationDateInterpretation.absoluteTime,
     androidAllowWhileIdle: true,
   );
   ```

---

## 🎯 推奨される通知設計

### 通知の優先度マトリクス

| 優先度 | 通知タイプ | 実装方法 | 具体例 |
|-------|----------|----------|-------|
| **高価値・高頻度** | プッシュ通知 | FCM | 習慣リマインダー、直近イベント |
| **高価値・低頻度** | アプリ内通知 | Provider | 週次分析、AI提案 |
| **低価値・高頻度** | バッジ通知 | Badge | 未完了タスク数 |
| **低価値・低頻度** | ログのみ | - | 統計更新、設定変更 |

### 通知設定の柔軟性

#### ユーザー設定項目
```dart
class NotificationSettings {
  // 習慣関連
  bool habitsEnabled;
  List<String> habitsTimes; // ["07:00", "19:00"]
  List<int> habitsDays; // [1,2,3,4,5] 平日のみ
  
  // タスク関連
  bool deadlineAlertEnabled;
  int deadlineAlertHours; // 24時間前
  bool completionCelebrationEnabled;
  
  // AI関連
  bool weeklyReportEnabled;
  bool instantInsightsEnabled;
  
  // 全体設定
  bool soundEnabled;
  bool vibrationEnabled;
  String quietHoursStart; // "22:00"
  String quietHoursEnd; // "07:00"
}
```

---

## 📅 段階的実装アプローチ

### Stage 1: 基本通知システム（1-2週間）
#### 目標
- アプリ内通知の基盤構築
- バッジ通知の実装

#### 実装項目
1. **NotificationProvider の作成**
   ```dart
   class NotificationProvider extends StateNotifier<NotificationState> {
     void showInAppNotification(String title, String message);
     void updateBadgeCount(int count);
     void clearAllNotifications();
   }
   ```

2. **アプリ内通知UI**
   - SnackBar による通知表示
   - 通知履歴画面
   - 通知設定画面

3. **バッジ通知**
   - 未完了タスク数の表示
   - 未読分析数の表示

#### 具体的な通知
- 🤖 AI分析完了通知
- ✅ タスク完了通知
- 🎉 習慣継続記録更新
- 📊 データ同期完了

### Stage 2: ローカル通知（1週間）
#### 目標
- スケジュール通知の実装
- 時間ベースのリマインダー

#### 実装項目
1. **flutter_local_notifications の統合**
2. **スケジュール管理**
   ```dart
   class LocalNotificationService {
     Future<void> scheduleHabitReminder(Habit habit);
     Future<void> scheduleDeadlineAlert(Task task);
     Future<void> scheduleEventReminder(CalendarEvent event);
   }
   ```

3. **通知チャンネル設定**
   - 習慣リマインダー
   - 締切アラート
   - カレンダーイベント

#### 具体的な通知
- ⏰ 締切24時間前アラート
- 🔄 習慣リマインダー（毎日定時）
- 📅 カレンダーイベント30分前

### Stage 3: プッシュ通知（2-3週間）
#### 目標
- FCM の完全実装
- サーバーサイドの通知送信

#### 実装項目
1. **Firebase プロジェクト設定**
2. **FCM 初期化とトークン管理**
   ```dart
   class FCMService {
     Future<String> getToken();
     Future<void> subscribeToTopic(String topic);
     void handleForegroundMessage(RemoteMessage message);
     void handleBackgroundMessage(RemoteMessage message);
   }
   ```

3. **バックエンドサーバー**
   - Node.js + Express
   - Firebase Admin SDK
   - 通知送信スケジューラー

4. **通知トリガー**
   - AI分析完了時
   - 重要な目標進捗時
   - 週次/月次レポート

#### 具体的な通知
- 🤖 AI週次レポート
- 🎯 重要な目標進捗
- 📊 月次分析完了

---

## 🤔 意思決定が必要な項目

### 1. 通知の頻度とタイミング
| 項目 | 選択肢 | 推奨 |
|------|-------|------|
| **習慣リマインダー** | 1日1回 / 1日2回 / カスタム | 1日1回（ユーザー設定可） |
| **締切アラート** | 1時間前 / 24時間前 / 1週間前 | 24時間前 |
| **AI分析レポート** | 即時 / 日次 / 週次 | 週次（日曜日19:00） |

### 2. 通知の内容とトーン
| 項目 | 選択肢 | 推奨 |
|------|-------|------|
| **文体** | カジュアル / フォーマル / 混合 | 混合（機能により分ける） |
| **絵文字使用** | 多用 / 控えめ / なし | 控えめ |
| **励ましの度合い** | 高 / 中 / 低 | 中 |

### 3. 通知設定のデフォルト値
| 項目 | 選択肢 | 推奨 |
|------|-------|------|
| **新規ユーザー** | 全て有効 / 最小限 / 段階的 | 最小限 |
| **サイレント時間** | 22:00-07:00 / 23:00-06:00 / なし | 22:00-07:00 |
| **週末通知** | 有効 / 無効 / 平日のみ | 平日のみ |

---

## 📊 成功指標とKPI

### 通知の効果測定

#### 定量的指標
| 指標 | 目標値 | 測定方法 |
|------|-------|----------|
| **通知開封率** | 80%以上 | 通知クリック数 / 送信数 |
| **習慣継続率** | 通知実装前より20%向上 | 習慣実行データ |
| **タスク完了率** | 締切前完了率90%以上 | タスクデータ分析 |
| **アプリ再訪問率** | 通知経由50%以上 | アプリ起動ログ |

#### 定性的指標
- ユーザーアンケート（通知の有用性）
- アプリストアレビュー（通知関連）
- サポート問い合わせ（通知設定）

### 通知疲れの防止

#### 監視指標
- 通知無効化率（10%以下を維持）
- 通知頻度（1日あたり5件以下）
- ユーザー離脱率（通知実装後の変化）

---

## 🗓️ 実装スケジュール

### 全体スケジュール（4-6週間）

#### Week 1-2: Stage 1 - 基本通知システム
- [ ] NotificationProvider 実装
- [ ] アプリ内通知UI作成
- [ ] バッジ通知実装
- [ ] 通知設定画面作成

#### Week 3: Stage 2 - ローカル通知
- [ ] flutter_local_notifications 統合
- [ ] スケジュール通知実装
- [ ] 通知チャンネル設定
- [ ] 習慣・タスク連携

#### Week 4-5: Stage 3 - プッシュ通知
- [ ] Firebase プロジェクト設定
- [ ] FCM 実装
- [ ] バックエンドサーバー構築
- [ ] 通知送信ロジック

#### Week 6: テスト・改善
- [ ] 統合テスト
- [ ] ユーザーテスト
- [ ] パフォーマンス最適化
- [ ] 本番リリース

---

## 🔧 実装時の注意点

### セキュリティ
- FCM トークンの適切な管理
- 通知内容の機密情報除外
- 通知権限の適切な処理

### パフォーマンス
- 通知データベースの最適化
- バックグラウンド処理の効率化
- メモリ使用量の監視

### ユーザビリティ
- 通知設定の分かりやすさ
- 通知内容の明確さ
- 通知頻度の調整機能

---

## 📝 完了条件

### 機能完了の定義
1. **Stage 1-3 の全実装完了**
2. **通知設定の完全動作**
3. **各通知タイプの正常動作確認**
4. **ユーザーテストの実施・改善**
5. **本番環境での動作確認**

### 計画書の削除タイミング
- 上記完了条件をすべて満たした時点
- 通知機能が本番環境で安定稼働開始後
- この計画書の内容を実装ドキュメントに移行完了後

---

## 🎯 まとめ

この計画書では、WellFinアプリの通知機能を段階的に実装するための包括的な計画を策定しました。

### 重要なポイント
1. **段階的実装**: 基本 → ローカル → プッシュ の順で実装
2. **ユーザー中心**: 通知疲れを防ぎ、価値ある通知のみ送信
3. **柔軟な設定**: ユーザーが通知をカスタマイズ可能
4. **効果測定**: KPIを設定し、通知の効果を定量的に評価

### 次のステップ
1. Stage 1 の実装開始
2. 通知設定の最終決定
3. 実装進捗の定期レビュー

---

> **再掲: この計画書の取り扱いについて**  
> この計画書は一時的な作業文書です。通知機能の実装が完了次第、内容を適切なドキュメントに移行し、この計画書は削除されます。

---

**作成日**: 2025年7月6日  
**最終更新**: 2025年7月6日  
**ステータス**: 作成完了・実装待ち 